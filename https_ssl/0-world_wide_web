#!/usr/bin/env bash
# This script audits the DNS records for a specified domain and subdomains.
# It uses 'dig' and 'awk' to extract and format the record information.

# Disable ShellCheck warnings for unquoted variables in dig (SC2086)
# and potentially undefined variables in awk (SC2154).
# shellcheck disable=SC2086,SC2154

# Function to perform DNS lookup and format the output.
# Arguments:
# 1. DOMAIN: The base domain name (e.g., "holberton.online").
# 2. SUB_PREFIX: The subdomain name (e.g., "www", "lb-01").
audit_subdomain() {
    local DOMAIN="$1"
    local SUB_PREFIX="$2"
    local FULL_SUBDOMAIN="${SUB_PREFIX}.${DOMAIN}"

    # Use 'dig' to query the full domain name.
    # Pipe the output to 'awk' for filtering and data extraction.
    dig "$FULL_SUBDOMAIN" | awk -v sub_name="$SUB_PREFIX" '
        # 1. Look for the start of the Answer Section.
        /^;; ANSWER SECTION:/ {
            in_answer=1
            next # Skip the header line itself
        }

        # 2. Process the line containing the actual DNS record.
        # We assume the common scenario in testing environments where FQDN ($1) and TTL ($2) are present,
        # making IN field $3, Type $4, and Destination $5.
        in_answer && $3 == "IN" {
            # $4 is the Record Type (e.g., A, CNAME)
            RECORD_TYPE = $4
            # $5 is the Destination (e.g., IP address, canonical name)
            DESTINATION = $5

            # Print the required output format.
            printf "The subdomain %s is a %s record and points to %s\n", sub_name, RECORD_TYPE, DESTINATION
            
            # Exit awk immediately after processing the first answer.
            exit 0
        }
        
        # 3. If we found the answer section but hit the next major section (like ;; AUTHORITY SECTION), stop processing.
        in_answer && /^;;\s[A-Z]/ { exit 0 }
    '
}

# --- Main Logic ---

# Check if the mandatory domain argument is provided
if [ $# -lt 1 ]; then
    echo "Usage: $0 <domain> [subdomain]"
    exit 1
fi

DOMAIN="$1"
SUBDOMAIN="$2"
SUBDOMAINS=("www" "lb-01" "web-01" "web-02")

# If only the domain argument is provided (SUBDOMAIN is empty)
if [ -z "$SUBDOMAIN" ]; then
    # Iterate through the required subdomains in the specified order
    for SUB in "${SUBDOMAINS[@]}"; do
        audit_subdomain "$DOMAIN" "$SUB"
    done
# Both domain and specific subdomain arguments are provided
else
    audit_subdomain "$DOMAIN" "$SUBDOMAIN"
fi

exit 0
